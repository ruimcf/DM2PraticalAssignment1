---
title: "DM2 Pratical Assigment 1"
author: "Pedro Belem, Rui Fonseca"
date: "18 March 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readxl)
library(lubridate)
library(arules)		
library(arulesViz)
```




```{r}
# Reads information from excel guide, used to label the data
read_excel_allsheets <- function(filename) {
  sheets <- readxl::excel_sheets(filename)
  sheets <- sheets[3:length(sheets)]
  x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
  names(x) <- sheets
  x
}


# Converts code values of col col_name to labels in excel_section_name
convert_codes <- function(df, col_name, excel_section_name) {
  df[[col_name]] <- sapply(df[[col_name]], function(i) if(!is.na(i)) subset(mysheets[[excel_section_name]], code == i)$label else NA)
  df
}

# Converts date and time content into separe columns
convert_date_and_time <- function(df) {
  df$Date <- as.Date(df$Date, "%d/%m/%Y")
  df$Day <- day(df$Date)               
  df$Month <- month(df$Date)
  df$Date <- NULL
  
  df$Time <- hm(df$Time)
  df$Hour <- hour(df$Time)
  df$Minute <- minute(df$Time)
  df$Time <- NULL
  df
}
```



```{r}
mysheets <- read_excel_allsheets("Road-Accident-Safety-Data-Guide.xls")
original.data <- read.csv(file="Accidents_2015.csv", header=TRUE)
useless <- c("Accident_Index", "Location_Easting_OSGR", "Location_Northing_OSGR", "Latitude", "Longitude", "LSOA_of_Accident_Location", "Minutes")
data.discretized <- original.data[, !names(original.data) %in% useless]
data.discretized <- convert_date_and_time(data.discretized)
data.discretized[data.discretized==-1] <- NA
head(data.discretized)

```
## Data pre processing
After analising the data, we found some attributes that will be irrelevant to our task.
Those are:

* Accident Index: Each number is unique to each accident so it doesn't contribute to any meaningful rules.
* Location Easting OSRG, Location Northing OSGR, Longitude, Latitude: all these attributes represent information about the local of the accident. We chose LSOA (Lower Layer Super Output Area) as the attribute representative of space. This will also help to group accidents in the same area together.


Time and date attibutes were changed.
With the Date attribute, month and day columns were created.
With the Time attribute, hour and minute attributes were created. However minutes attribute will not be taken in consideration in rule generation.


## Data discretization

To effectively generate rules the data needs to be discretized

* Number of Vehicles: 1, 2, 3, 4, 5+
* Number of Casualties: 1, 2, 3, 4, 5+
* Day: split in 4 intervals, representing the weeks of the month.
* Hour: Hours of the day will be split in intervals of 3 hours each, starting at midnight.

```{r, eval=FALSE}
# Discriteze all data 

# Police Force
data.discretized <- convert_codes(data.discretized, "Police_Force", "Police Force")
data.discretized$Police_Force <- factor(data.discretized$Police_Force)
# Accident Severity
data.discretized <- convert_codes(data.discretized, "Accident_Severity", "Accident Severity")
data.discretized$Accident_Severity <- factor(data.discretized$Accident_Severity)
# Number of Vehicles
n_vehicles.range <- c(1,2,3,4,5,Inf)
data.discretized$Number_of_Vehicles <- discretize(data.discretized$Number_of_Vehicles, method = "fixed", categories = n_vehicles.range)
# Number of Casualties
n_casualties.range <- c(1,2,3,4,5,Inf)
data.discretized$Number_of_Casualties <- discretize(data.discretized$Number_of_Casualties, method = "fixed", categories = n_casualties.range)
# Day of Week
data.discretized <- convert_codes(data.discretized, "Day_of_Week", "Day of Week")
data.discretized$Day_of_Week <- factor(data.discretized$Day_of_Week)
# Local Authority District
data.discretized <- convert_codes(data.discretized, "Local_Authority_.District.", "Local Authority (District)")
data.discretized$Local_Authority_.District. <- factor(data.discretized$Local_Authority_.District.)
# Local Authority Highway
data.discretized <- convert_codes(data.discretized, "Local_Authority_.Highway.", "Local Authority (Highway)")
data.discretized$Local_Authority_.Highway. <- factor(data.discretized$Local_Authority_.Highway.)
# 1st Road Class
data.discretized <- convert_codes(data.discretized, "X1st_Road_Class", "1st Road Class")
data.discretized$X1st_Road_Class <- factor(data.discretized$X1st_Road_Class)
# 1st Road Number
data.discretized$X1st_Road_Number <- factor(data.discretized$X1st_Road_Number)
# Road Type
data.discretized <- convert_codes(data.discretized, "Road_Type", "Road Type")
data.discretized$Road_Type <- factor(data.discretized$Road_Type)
# Speed Limit
data.discretized$Speed_limit <- factor(data.discretized$Speed_limit)
# Junction Detail
data.discretized <- convert_codes(data.discretized, "Junction_Detail", "Junction Detail")
data.discretized$Junction_Detail <- factor(data.discretized$Junction_Detail, exclude = NULL)
# Junction Control
data.discretized <- convert_codes(data.discretized, "Junction_Control", "Junction Control")
data.discretized$Junction_Control <- factor(data.discretized$Junction_Control, exclude = NULL)
# 2nd Road Class
data.discretized <- convert_codes(data.discretized, "X2nd_Road_Class", "2nd Road Class")
data.discretized$X2nd_Road_Class <- factor(data.discretized$X2nd_Road_Class, exclude = NULL)
# 2nd Road Number
data.discretized$X2nd_Road_Number <- factor(data.discretized$X2nd_Road_Number)
# Ped Cross - Human
data.discretized <- convert_codes(data.discretized, "Pedestrian_Crossing.Human_Control", "Ped Cross - Human")
data.discretized$Pedestrian_Crossing.Human_Control <- factor(data.discretized$Pedestrian_Crossing.Human_Control, exclude = NULL)
# Ped Cross - Physical
data.discretized <- convert_codes(data.discretized, "Pedestrian_Crossing.Physical_Facilities", "Ped Cross - Physical")
data.discretized$Pedestrian_Crossing.Physical_Facilities <- factor(data.discretized$Pedestrian_Crossing.Physical_Facilities)
# Light Conditions
data.discretized <- convert_codes(data.discretized, "Light_Conditions", "Light Conditions")
data.discretized$Light_Conditions <- factor(data.discretized$Light_Conditions)
# Weather Conditions
data.discretized <- convert_codes(data.discretized, "Weather_Conditions", "Weather")
data.discretized$Weather_Conditions <- factor(data.discretized$Weather_Conditions)
# Road Surface
data.discretized <- convert_codes(data.discretized, "Road_Surface_Conditions", "Road Surface")
data.discretized$Road_Surface_Conditions <- factor(data.discretized$Road_Surface_Conditions)
# Special Conditions
data.discretized <- convert_codes(data.discretized, "Special_Conditions_at_Site", "Special Conditions at Site")
data.discretized$Special_Conditions_at_Site <- factor(data.discretized$Special_Conditions_at_Site)
# Carriageway Hazards
data.discretized <- convert_codes(data.discretized, "Carriageway_Hazards", "Carriageway Hazards")
data.discretized$Carriageway_Hazards <- factor(data.discretized$Carriageway_Hazards)
# Urban Rural
data.discretized <- convert_codes(data.discretized, "Urban_or_Rural_Area", "Urban Rural")
data.discretized$Urban_or_Rural_Area <- factor(data.discretized$Urban_or_Rural_Area)
# Police Officer Attend
data.discretized <- convert_codes(data.discretized, "Did_Police_Officer_Attend_Scene_of_Accident", "Police Officer Attend")
data.discretized$Did_Police_Officer_Attend_Scene_of_Accident <- factor(data.discretized$Did_Police_Officer_Attend_Scene_of_Accident)
# Day
data.discretized$Day <- discretize(data.discretized$Day, method="interval", categories=4)
# Hour
hour.range <- c(3,6,9,12,15,18,21,Inf)
data.discretized$Hour <- discretize(data.discretized$Hour, method="fixed", categories=hour.range)

head(data.discretized)
```
